#!/bin/bash

DIR=$(dirname "$(realpath "$0")")
HOME_DIR=~/.startenv

STARTENVJS=startenv.js

# return value
__=""

find_file_upwards () {
    dir_to_check=${2:-`pwd`}
    file_to_find="$1"

    while [ "$dir_to_check" != "/" ]; do

        if [ -f "$dir_to_check/$file_to_find" ]; then
            __="$dir_to_check/$file_to_find"
            return
        fi

        dir_to_check=`dirname "$dir_to_check"`
   done
}

list_command() {
    for i in $HOME_DIR/*.js; do
        echo "$1$(basename "$i" .js)"
    done
}

if [ "$1" == "init" ]; then
    if [ -z "$2" ]; then
        echo "Error: you need to specify project name as a second argument."
        exit 1
    fi

    PROJECT_NAME=`basename "$2"`

    if [ $# -gt 2 ]; then
        echo "Warning: extra arguments at the command line."
    fi

    if [ ! -d "$HOME_DIR" ]; then
        mkdir "$HOME_DIR"

        if [ $? != 0 ]; then
            echo "Error: couldn't create $HOME_DIR directory." 
            echo "Make sure your permissions are ok."
            exit 1
        fi
    fi

    sed "s/PROJECT_NAME/$PROJECT_NAME/g" "$DIR/examples/fullexample.js" > "$HOME_DIR/$PROJECT_NAME.js"

    echo "Created $HOME_DIR/$PROJECT_NAME.js"
    echo "Make necessary edits in the file and start the environment with:"
    echo ""
    echo "startenv $PROJECT_NAME"

    exit 0
elif [ "$1" == "list" ]; then
    list_command

    exit 0
fi

if [ ! -d "$HOME_DIR" ]; then
    echo "The $HOME_DIR directory does not exist."
    echo "To create your first environment, type the following in your terminal:"
    echo ""
    echo "startenv init PROJECT_NAME"
    exit 1
fi

if [ $# -eq 0 ]; then
    find_file_upwards "$STARTENVJS"

    if [ ! -f "$__" ]; then
        echo "Usage: startenv PROJECT_NAME"
        echo "Available environments:"

        list_command "   "

        echo "Fatal: did not find $STARTENVJS here (or any of the parent directories)."
        exit 1
    fi

    SCRIPT="$__"

    project_dir=`dirname "$SCRIPT"`
    PROJECT_NAME=`basename "$project_dir"`

    symlink_target="$HOME_DIR/$PROJECT_NAME.js"

    if [ ! -f "$symlink_target" ]; then
        echo "Linking as $HOME_DIR/$PROJECT_NAME.js"
        echo "Next time you will be able to use the following command"
        echo ""
        echo "startenv $PROJECT_NAME"

        ln -s "$SCRIPT" "$symlink_target"
    fi
else
    PROJECT_NAME=`basename "$1"`
fi

if [ $# -gt 2 ]; then
    echo "Warning: extra arguments at the command line."
fi

SCRIPT="$HOME_DIR/$PROJECT_NAME.js"

if [ ! -f "$SCRIPT" ]; then
    echo "Error: $SCRIPT does not exist. Exiting..."
    exit 1
fi

osascript -l JavaScript  "$DIR/Run.applescript" "$SCRIPT" "$2"
